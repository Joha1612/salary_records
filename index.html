<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶¨‡ßá‡¶§‡¶® ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f7fa;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .form-container, .table-container {
      background: white;
      border-radius: 8px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      flex: 1;
      min-width: 300px;
    }
    h1 {
      color: #1a73e8;
      text-align: center;
      margin-bottom: 25px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #5f6368;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 16px;
    }
    input:focus, select:focus {
      border-color: #1a73e8;
      outline: none;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
    }
    .submit-btn {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 12px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
    }
    .submit-btn:hover {
      background: #1765cc;
    }
    #message {
      margin-top: 20px;
      padding: 12px;
      border-radius: 4px;
      display: none;
    }
    .success {
      background: #e6f4ea;
      color: #137333;
      border: 1px solid #b6e1c1;
    }
    .error {
      background: #fce8e6;
      color: #d93025;
      border: 1px solid #f5b9b1;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #f1f3f4;
    }
    /* filtering */
    .filter-section {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
  align-items: flex-end;
}

.filter-section .form-group {
  margin-bottom: 0;
  flex: 1;
}

.filter-section button {
  width: auto;
  padding: 12px 20px;
}
.filter-section {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
  align-items: flex-end;
  flex-wrap: wrap;
}

.filter-section .form-group {
  margin-bottom: 0;
  flex: 1;
  min-width: 150px;
}

.filter-btn, .cancel-btn {
  width: auto;
  padding: 12px 20px;
  font-size: 14px;
}

.filter-btn {
  background: #1a73e8;
}

.cancel-btn {
  background: #f44336;
  border: none;
  color: white;
  border-radius: 4px;
  cursor: pointer;
}

.cancel-btn:hover {
  background: #d32f2f;
}
/* ‡¶è‡¶ï‡¶∂‡¶® ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
.action-buttons {
  display: flex;
  gap: 15px;
  margin: 20px 0;
}

.action-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  color: white;
}

.pdf-btn {
  background-color: #d32f2f;
}

.print-btn {
  background-color: #388e3c;
}

.action-btn:hover {
  opacity: 0.9;
}

/* ‡¶™‡ßá‡¶ú‡¶ø‡¶®‡ßá‡¶∂‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 15px;
  margin-top: 20px;
}

.pagination button {
  padding: 8px 16px;
  background-color: #1a73e8;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.pagination button:disabled {
  background-color: #cccccc;
  cursor: not-allowed;
}

/* ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
@media print {
  .form-container, .filter-section, .action-buttons, .pagination {
    display: none;
  }
  
  body {
    background-color: white;
    padding: 0;
  }
  
  .table-container {
    box-shadow: none;
    padding: 0;
  }
}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<div class="container">
  <!-- Form Section -->
  <div class="form-container">
    <h1>‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶¨‡ßá‡¶§‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h1>
    <form id="salaryForm">
      <div class="form-group">
        <label for="date">Date</label>
        <input type="date" id="date" name="date">
      </div>

      <div class="form-group">
        <label for="year">Year</label>
        <select id="year" name="year" required>
          <option value="">‡¶¨‡¶õ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
          <option value="2024">2024</option>
          <option value="2025">2025</option>
          <option value="2026">2026</option>
        </select>
      </div>

      <div class="form-group">
        <label for="month">Month</label>
        <select id="month" name="month" required>
          <option value="">‡¶Æ‡¶æ‡¶∏ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
          <option value="January">January</option>
          <option value="February">February</option>
          <option value="March">March</option>
          <option value="April">April</option>
          <option value="May">May</option>
          <option value="June">June</option>
          <option value="July">July</option>
          <option value="August">August</option>
          <option value="September">September</option>
          <option value="October">October</option>
          <option value="November">November</option>
          <option value="December">December</option>
        </select>
      </div>

      <div class="form-group">
        <label for="paymentType">Payment type</label>
        <select id="paymentType" name="paymentType" required>
          <option value="">‡¶ü‡¶æ‡¶á‡¶™ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
          <option value="Full">Full</option>
          <option value="Partial">Partial payment</option>
        </select>
      </div>

      <div class="form-group">
        <label for="salaryAmount">Salary Amount (‡ß≥)</label>
        <input type="hidden" id="salaryAmount" name="salaryAmount" value="30000" readonly step="0.01" min="0">
      </div>

      <div class="form-group">
        <label for="amountPayable">Amount payable</label>
        <input type="number" id="amountPayable" name="amountPayable" required step="0.01" min="0">
      </div>

      <div class="form-group">
        <!-- <label for="monthlyDue">Monthly due</label> -->
        <input type="hidden" id="monthlyDue" name="monthlyDue" required readonly>
      </div>

      <div class="form-group">
        <!-- <label for="totalDue">Total due</label> -->
        <input type="hidden" id="totalDue" name="totalDue" readonly>
      </div>

      <div class="form-group">
        <label for="comments">Comment</label>
        <textarea id="comments" name="comments" rows="2"></textarea>
      </div>

      <button type="submit" class="submit-btn">Submit</button>
    </form>
    <div id="message"></div>
  </div>

  <!-- Table Section -->
<div class="table-container">
    <!-- <h2>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡ßü‡¶æ: <span id="displayTotalDue">0</span> ‡ß≥</h2> -->
    
    <!-- ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® -->
    <div class="filter-section">
      <div class="form-group">
        <label for="filterMonth">‡¶Æ‡¶æ‡¶∏ ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞</label>
        <select id="filterMonth" name="filterMonth">
          <option value="">‡¶∏‡¶¨ ‡¶Æ‡¶æ‡¶∏</option>
          <option value="January">January</option>
          <option value="February">February</option>
          <option value="March">March</option>
          <option value="April">April</option>
          <option value="May">May</option>
          <option value="June">June</option>
          <option value="July">July</option>
          <option value="August">August</option>
          <option value="September">September</option>
          <option value="October">October</option>
          <option value="November">November</option>
          <option value="December">December</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="filterYear">‡¶¨‡¶õ‡¶∞ ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞</label>
        <select id="filterYear" name="filterYear">
          <option value="">‡¶∏‡¶¨ ‡¶¨‡¶õ‡¶∞</option>
          <option value="2024">2024</option>
          <option value="2025">2025</option>
          <option value="2026">2026</option>
        </select>
      </div>
      
      <button type="button" onclick="applyFilters()" class="submit-btn">‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      <button type="button" onclick="resetFilters()" class="cancel-btn">‡¶ï‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏‡ßá‡¶≤</button>
    </div>
    
    <table id="salaryTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Month</th>
            <th>Year</th>
            <th>Paid</th>
            <th>Due</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <!-- Table Section ‡¶è‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá ‡¶è‡¶á ‡¶¨‡¶æ‡¶ü‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® -->
<div class="action-buttons">
    <button onclick="generatePDF()" class="action-btn pdf-btn">PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
    <button onclick="window.print()" class="action-btn print-btn">‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
    <button onclick="generateReport()">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
  </div>
  
  <!-- ‡¶™‡ßá‡¶ú‡¶ø‡¶®‡ßá‡¶∂‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤ -->
  <div class="pagination">
    <button id="prevPage" onclick="prevPage()" disabled>‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ</button>
    <span id="pageInfo">‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ 1</span>
    <button id="nextPage" onclick="nextPage()">‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ</button>
  </div>
  <h3>Salary Report<h3>
  <!-- ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® -->
    <div class="filter-section">
      <div class="form-group">
        <label for="filterMonth">‡¶Æ‡¶æ‡¶∏ ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞</label>
        <select id="filterType" name="filterType">
          <option value="">All</option>
          <option value="Paid">Paid</option>
          <option value="Due">Due</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="filterYear">‡¶¨‡¶õ‡¶∞ ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞</label>
        <select id="filterYear1" name="filterYear">
          <option value="">‡¶∏‡¶¨ ‡¶¨‡¶õ‡¶∞</option>
          <option value="2024">2024</option>
          <option value="2025">2025</option>
          <option value="2026">2026</option>
        </select>
      </div>
      
      <button type="button" onclick="applyFilters1()" class="submit-btn">‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      <button type="button" onclick="resetFilters2()" class="cancel-btn">‡¶ï‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏‡ßá‡¶≤</button>
    </div>
  <p id="reportTotalDue" style="font-weight: bold; margin-bottom: 10px;">Total Due: 0 Taka</p>
<table id="reportTable" border="1">
  <thead>
    <tr>
      <th>Month</th>
      <th>Year</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<!-- Button to trigger -->
<button onclick="generateFilteredReportPDF()">üìÑ PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
</div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
  // ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶´‡¶ø‡¶≤‡ßç‡¶°‡ßá ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
  document.getElementById('date').value = new Date().toISOString().split('T')[0];

  loadJS();            // jsPDF ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø ‡¶≤‡ßã‡¶°
  fetchTotalDue();     // ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶≤‡ßã‡¶°
  loadTableData();     // ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶°
  setupEventListeners(); // ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™
});

// ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤
let currentPage = 1;
const rowsPerPage = 12;
let allData = [];
const endpoint = 'https://script.google.com/macros/s/AKfycbxWlGYvy9AfQnsE6b0Zr4PD5JaYLCvR15p5qGPPsEjxQZhUlmPGslcKZ9kJeMRR_IPoFA/exec';

// ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™
function setupEventListeners() {
  document.getElementById('amountPayable').addEventListener('input', calculateDue);
  document.getElementById('salaryForm').addEventListener('submit', submitSalaryData);
  document.getElementById('prevPage').addEventListener('click', prevPage);
  document.getElementById('nextPage').addEventListener('click', nextPage);
  document.querySelector('.filter-btn').addEventListener('click', applyFilters);
  document.querySelector('.cancel-btn').addEventListener('click', resetFilters);
}
// ‡¶¨‡ßá‡¶§‡¶® ‡¶ì ‡¶™‡ßç‡¶∞‡¶¶‡ßá‡¶Ø‡¶º ‡¶Ö‡¶∞‡ßç‡¶• ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨
function calculateDue() {
  const salary = parseFloat(document.getElementById('salaryAmount').value) || 0;
  const payable = parseFloat(document.getElementById('amountPayable').value) || 0;
  const due = salary - payable;
  document.getElementById('monthlyDue').value = due >= 0 ? due.toFixed(2) : 0;
}
// ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶´‡ßá‡¶ö
async function fetchTotalDue() {
  try {
    const response = await fetch(endpoint);
    if (!response.ok) throw new Error('Network error');
    const data = await response.json();
    document.getElementById('totalDue').value = data.totalDue.toFixed(2);
    document.getElementById('displayTotalDue').textContent = data.totalDue.toFixed(2);
  } catch (error) {
    console.error('Total due fetch error:', error);
  }
}

// ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ì ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
async function loadTableData() {
  const month = document.getElementById('filterMonth').value;
  const year = document.getElementById('filterYear').value;
  let url = `${endpoint}?action=read`;
  if (month) url += `&month=${encodeURIComponent(month)}`;
  if (year) url += `&year=${encodeURIComponent(year)}`;

  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error('Network error');
    const data = await response.json();
    allData = data.entries || [];
    currentPage = 1;
    updateTable();
  } catch (error) {
    console.error('Error loading data:', error);
    showMessage('‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
  }
}

// ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü (‡¶™‡ßá‡¶ú ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ)
function updateTable() {
  const tbody = document.querySelector('#salaryTable tbody');
  tbody.innerHTML = '';

  const startIdx = (currentPage - 1) * rowsPerPage;
  const paginatedData = allData.slice(startIdx, startIdx + rowsPerPage);
  let totalDue = 0;

  if (paginatedData.length > 0) {
    paginatedData.forEach(row => {
      const tr = document.createElement('tr');
      const due = parseFloat(row.monthlyDue) || 0;

      // ‚úÖ ‡¶∂‡¶∞‡ßç‡¶§ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶∞‡¶ô ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
      if (due === 0) {
        tr.style.backgroundColor = '#d4edda'; // Light green for no due
        tr.style.color = '#155724'; // Dark green text
      } else {
        tr.style.backgroundColor = '#f8d7da'; // Light red for due
        tr.style.color = '#721c24'; // Dark red text
      }
      tr.innerHTML = `
        <td>${formatDate(row.date)}</td>
        <td>${row.month || ''}</td>
        <td>${row.year || ''}</td>
        <td>${row.amountPayable || '0'}</td>
        <td>${row.monthlyDue || '0'}</td>`;
      tbody.appendChild(tr);
      totalDue += parseFloat(row.monthlyDue) || 0;
    });
  } else {
    tbody.innerHTML = '<tr><td colspan="6">‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</td></tr>';
  }

  updatePaginationControls();
  updateTotalDueDisplay(totalDue);
}

// Pagination & Total
function updatePaginationControls() {
  const totalPages = Math.ceil(allData.length / rowsPerPage);
  document.getElementById('pageInfo').textContent = `‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ${currentPage} / ${totalPages}`;
  document.getElementById('prevPage').disabled = currentPage === 1;
  document.getElementById('nextPage').disabled = currentPage >= totalPages;
}

function updateTotalDueDisplay(totalDue) {
  document.getElementById('totalDue').value = totalDue.toFixed(2);
  document.getElementById('displayTotalDue').textContent = totalDue.toFixed(2);
}

// Pagination actions
function nextPage() {
  const totalPages = Math.ceil(allData.length / rowsPerPage);
  if (currentPage < totalPages) {
    currentPage++;
    updateTable();
  }
}

function prevPage() {
  if (currentPage > 1) {
    currentPage--;
    updateTable();
  }
}

// Filter actions
function applyFilters() {
  loadTableData();
}

function resetFilters() {
  document.getElementById('filterMonth').value = '';
  document.getElementById('filterYear').value = '';
  loadTableData();
  showMessage('‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏‡ßá‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
}

// Form submit
async function submitSalaryData(event) {
  event.preventDefault();
  const form = document.getElementById("salaryForm");
  const formData = new FormData(form);

  const date = formData.get("date");
  const year = formData.get("year");
  const month = formData.get("month");
  const amountPayable = parseFloat(formData.get("amountPayable")) || 0;
  const fixedSalary = parseFloat(formData.get("salaryAmount")) || 0;

  try {
    const response = await fetch(`${endpoint}?action=read&month=${month}&year=${year}`);
    const data = await response.json();
    const entries = data.entries || [];
    const paidSoFar = entries.reduce((sum, e) => sum + (parseFloat(e.amountPayable) || 0), 0);

    const totalPaid = paidSoFar + amountPayable;
    const monthlyDue = Math.max(fixedSalary - totalPaid, 0);
    const totalDue = await calculateTotalDue(month, year, amountPayable, fixedSalary);

    formData.set("monthlyDue", monthlyDue.toFixed(2));
    formData.set("salaryAmount", fixedSalary);
    formData.set("totalDue", totalDue.toFixed(2));

    const submitResponse = await fetch(endpoint, {
      method: "POST",
      body: formData,
    });

    const result = await submitResponse.text();
    if (result === "Success") {
      showMessage("‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá", "success");
      form.reset();
      fetchTotalDue();
      loadTableData();
    } else {
      throw new Error(result);
    }
  } catch (error) {
    console.error("Submission Error:", error);
    showMessage("‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá", "error");
  }
}

// ‡¶Æ‡¶æ‡¶∏‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶ì ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨
async function calculateTotalDue(currentMonth, currentYear, currentPayable, currentSalary) {
  const response = await fetch(`${endpoint}?action=read`);
  const data = await response.json();
  const allEntries = data.entries || [];

  // ‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Ö‡¶®‡ßç‡¶§‡¶∞‡ßç‡¶≠‡ßÅ‡¶ï‡ßç‡¶§
  const extendedEntries = [...allEntries, {
    month: currentMonth,
    year: currentYear,
    amountPayable: currentPayable,
    salaryAmount: currentSalary
  }];

  const paidMap = {};
  const salaryMap = {};
  const finalMonthDue = {};

  for (const entry of extendedEntries) {
    const key = `${entry.month}_${entry.year}`;
    const paid = parseFloat(entry.amountPayable || 0);
    const salary = parseFloat(entry.salaryAmount || 0);

    paidMap[key] = (paidMap[key] || 0) + paid;
    salaryMap[key] = salary; // ‡¶ß‡¶∞‡ßá ‡¶®‡¶ø‡¶ö‡ßç‡¶õ‡¶ø ‡¶Æ‡¶æ‡¶∏‡ßá ‡¶è‡¶ï‡¶ü‡¶æ‡¶á salaryAmount ‡¶•‡¶æ‡¶ï‡¶¨‡ßá ‡¶¨‡¶æ ‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶æ‡¶ß‡¶æ‡¶®‡ßç‡¶Ø ‡¶™‡¶æ‡¶¨‡ßá

    finalMonthDue[key] = Math.max((salaryMap[key] || 0) - paidMap[key], 0);
  }

  return Object.values(finalMonthDue).reduce((sum, due) => sum + due, 0);
}

// Date format
function formatDate(dateString) {
  if (!dateString) return '';
  const date = new Date(dateString);
  if (isNaN(date.getTime())) return dateString;
  return `${String(date.getDate()).padStart(2, '0')}-${String(date.getMonth() + 1).padStart(2, '0')}-${date.getFullYear()}`;
}

// Message
function showMessage(text, type) {
  const messageEl = document.getElementById('message');
  messageEl.className = type;
  messageEl.textContent = text;
  messageEl.style.display = 'block';
  setTimeout(() => messageEl.style.display = 'none', 5000);
}

// jsPDF loader
function loadJS() {
  if (!document.querySelector('script[src*="jspdf"]')) {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
    document.head.appendChild(script);

    const script2 = document.createElement('script');
    script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js';
    document.head.appendChild(script2);
  }
  if (!document.querySelector('script[src*="autotable"]')) {
    const script2 = document.createElement('script');
    script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js';
    document.head.appendChild(script2);
  }
}
// generateReport
function generateReport() {
  const monthYearMap = {};
  let totalDue = 0;

  // ‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ entry ‡¶ß‡¶∞‡ßá ‡¶∞‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø map
  allData.forEach(entry => {
    const key = `${entry.month}_${entry.year}`;
    monthYearMap[key] = entry; // ‡¶è‡¶ï‡¶á ‡¶Æ‡¶æ‡¶∏/‡¶¨‡¶õ‡¶∞ ‡¶π‡¶≤‡ßá ‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ entry overwrite ‡¶ï‡¶∞‡¶¨‡ßá
  });

  const tbody = document.querySelector('#reportTable tbody');
  tbody.innerHTML = '';

  Object.values(monthYearMap).forEach(entry => {
    const tr = document.createElement('tr');
    const due = parseFloat(entry.monthlyDue || 0);

    let statusText, statusColor;
    if (due === 0) {
      statusText = "Paid";
      statusColor = "green";
    } else {
      statusText = `Due: ${due.toFixed(2)} Taka`;
      statusColor = "red";
      totalDue += due;
    }

    tr.innerHTML = `
      <td>${entry.month}</td>
      <td>${entry.year}</td>
      <td style="color:${statusColor}; font-weight:bold;">${statusText}</td>
    `;
    tbody.appendChild(tr);
  });
  // ‡¶â‡¶™‡¶∞‡ßá ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡ßü‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì
  const totalDueElement = document.getElementById('reportTotalDue');
  totalDueElement.textContent = `Total Due: ${totalDue.toFixed(2)} Taka`;
}
 
async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // PDF ‡¶π‡ßá‡¶°‡¶æ‡¶∞
    doc.setFontSize(16);
    doc.text("salary report", 14, 15);

    // ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶ì ‡¶∏‡¶Æ‡ßü
    const date = new Date();
    const formattedDate = date.toLocaleDateString('en-GB', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
    const formattedTime = date.toLocaleTimeString('en-GB');
    doc.setFontSize(10);
    doc.text(`Date: ${formattedDate} Time: ${formattedTime}`, 14, 22);

    // ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π
    const table = document.getElementById("salaryTable");
    const headers = [];
    table.querySelectorAll("thead tr th").forEach(th => {
      headers.push(th.innerText);
    });

    const rows = [];
    table.querySelectorAll("tbody tr").forEach(tr => {
      const row = [];
      tr.querySelectorAll("td").forEach(td => {
        row.push(td.innerText);
      });
      if (row.length > 0) rows.push(row);
    });

    if (rows.length === 0) {
      alert("‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!");
      return;
    }

    // AutoTable ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá PDF-‡¶è ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ
    doc.autoTable({
      startY: 30,
      head: [headers],
      body: rows,
      styles: { font: 'helvetica', fontSize: 10 },
      headStyles: { fillColor: [0, 102, 204] },
    });

    // ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡ßü‡¶æ ‡¶ü‡ßã‡¶ü‡¶æ‡¶≤ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ
    const totalDueText = document.getElementById("reportTotalDue").textContent;
    doc.setFontSize(12);
    doc.setTextColor(255, 0, 0);
    doc.text(totalDueText, 14, doc.lastAutoTable.finalY + 10);

    // PDF ‡¶∏‡ßá‡¶≠
    doc.save("salary_report.pdf");
  }
// generateStatusReportPDF

  async function generateFilteredReportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Header
    doc.setFontSize(16);
    doc.text("Salary Report", 14, 15);

    // Date & Time
    const date = new Date();
    const formattedDate = date.toLocaleDateString('en-GB', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
    const formattedTime = date.toLocaleTimeString('en-GB');
    doc.setFontSize(10);
    doc.text(`Date: ${formattedDate} Time: ${formattedTime}`, 14, 22);

    // Collect data from the visible reportTable rows
    const table = document.getElementById("reportTable");
    const headers = [];
    table.querySelectorAll("thead tr th").forEach(th => {
      headers.push(th.innerText.trim());
    });

    const rows = [];
    table.querySelectorAll("tbody tr").forEach(tr => {
      if (tr.style.display !== "none") { // Only visible rows
        const row = [];
        tr.querySelectorAll("td").forEach(td => {
          row.push(td.innerText.trim());
        });
        if (row.length > 0) rows.push(row);
      }
    });

    if (rows.length === 0) {
      alert("No filtered data found for PDF.");
      return;
    }

    // Insert filtered data into PDF using AutoTable
    doc.autoTable({
      startY: 30,
      head: [headers],
      body: rows,
      styles: { font: 'helvetica', fontSize: 10 },
      headStyles: { fillColor: [0, 102, 204] },
    });

    // Total Due text (if available)
    const totalDueText = document.getElementById("reportTotalDue")?.textContent;
    if (totalDueText) {
      doc.setFontSize(12);
      doc.setTextColor(255, 0, 0);
      doc.text(totalDueText, 14, doc.lastAutoTable.finalY + 10);
    }

    // Save PDF
    doc.save("filtered_salary_report.pdf");
  }

  function applyFilters1() {
  const filterType = document.getElementById("filterType").value;
  const filterYear = document.getElementById("filterYear1").value;

  const table = document.getElementById("reportTable");
  const rows = table.querySelectorAll("tbody tr");

  rows.forEach(row => {
    const status = row.querySelector("td:nth-child(3)").textContent.trim();
    const year = row.querySelector("td:nth-child(2)").textContent.trim();

    let show = true;

    if (filterType && !status.includes(filterType)) {
      show = false;
    }

    if (filterYear && filterYear !== year) {
      show = false;
    }

    row.style.display = show ? "" : "none";
  });
}

function resetFilters2() {
  document.getElementById("filterType").value = "";
  document.getElementById("filterYear1").value = "";
  applyFilters1(); // Reset filters by applying with empty values
}

</script>
</body>
</html>